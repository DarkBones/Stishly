var transactionsmenu_triggered = false;

$(document).on('turbolinks:load', ()=> {
  HideCardforms();
  $('.card-form__close').on('click', (event) => {
    ToggleCardForm('#' + $(event.target).closest('.card-form').attr('id'));
  });
  
});

// hide all visible card forms
function HideCardforms(){
  $('.card-form').each(function(index, item) {
    if ($(this).is(':visible')){
      ToggleCardForm('#' + $(this).attr('id'));
    }
  });
}

// hide all cardforms when pressing the Escape key
$(document).keydown(function(e) {
   if (e.key === "Escape") { // escape key maps to keycode `27`
    HideCardforms();
  }
});

// toggle card form with given id
function ToggleCardForm (formId) {
  $('#overlay').fadeToggle(200);
  $(formId).slideToggle(100);

  if (formId == "#transactionmenu") {
    $('#transaction_date').val(get_date());
    $('#transaction_time').val(get_time());
  }
}

// display the transactions menu through ajax
function ShowTransactionsMenu() {
  transactionsmenu_triggered = true;
  $.ajax({
    type: 'GET',
    dataType: 'text',
    url: '/api/render_transactionsmenu',
    success: function(data) {
      $('#content').prepend(data);
    }
  });
}

// clear the form values
function ClearValues (formId) {
  if (formId == '#accountmenu') {
      $.ajax({
        type: "GET",
        dataType: "text",
        url: "/api/user_currency",
        success: function(data) {
          $(formId).find("select#account_currency").val(data);
        }
      });
      $("#accountmenu input[type=text], #accountmenu textarea").val("");
  } else if (formId == '#transactionmenu'){
    $('#transaction_description').val('');
    $('#transaction_type').val('Expense');
    var account = get_active_account_name();
    if (account.length > 0) {
      $('#transaction_active_account').val(account);
      $('#transaction_account').val(account);
      $('#transaction_from_account').val(account);
      $.ajax({
        type: "GET",
        dataType: "text",
        url: "/api/account_currency/" + account,
        success: function(data) {
          $(formId).find("#transaction_currency").val(data);
        }
      });
    } else{
      $.ajax({
        type: "GET",
        dataType: "text",
        url: "/api/user_currency",
        success: function(data) {
          $(formId).find("#transaction_currency").val(data);
        }
      });
      $('#transaction_account').val($('#transaction_account').find('option').first().val());
      $('#transaction_from_account').val($('#transaction_account').val());
      $('#transaction_active_account').val($('#transaction_account').val());
    }
    $('#transaction_to_account').val($('#transaction_to_account').find('option').first().val());
    $('#transaction_multiple_transactions').prop('checked', false);
    $('#transaction_amount').val('');
    $('#transaction_transactions').val('');
    SetupTransactionForm();
  }
}

// set up the transactions menu to show / hide the correct fields
function SetupTransactionForm() {
  var currency_changed = false;
  var active_account_name = get_active_account_name();

  $('#create-transaction-button').on('click', () => {
    $(".accountmenu__name").focus();
  });

  $('#transaction_currency').change(function() {
    currency_changed = true;
  });

  $('.transactions_menu_multiple_accounts').hide();
  $('.transactions_menu_single_account').show();

  $('.transactions_menu_multiple').hide();
  $('.transactions_menu_single').show();

  $('#transaction_multiple_transactions').change(function() {
    if($(this).is(":checked")) {
      $('.transactions_menu_multiple').show();
      $('.transactions_menu_single').hide();
    } else {
      $('.transactions_menu_multiple').hide();
      $('.transactions_menu_single').show();
    }
  });

  $('#transaction_type').change(function() {
    if($(this).val().toLowerCase() == 'transfer'){
      $('.transactions_menu_multiple_accounts').show();
      $('.transactions_menu_single_account').hide();
    } else {
      $('.transactions_menu_multiple_accounts').hide();
      $('.transactions_menu_single_account').show();
    }
  });

  $('#transaction_account').change(function() {
    set_currency($(this).val(), currency_changed, $('#transaction_currency'));
  });

  $('#transaction_from_account').change(function() {
    set_currency($(this).val(), currency_changed, $('#transaction_currency'));
  });

  var currentDate = new Date();
  $('#transaction_date').val(get_date());
  $('#transaction_time').val(get_time());

  transactionmenu_set = true;
}

function ChangeType(type) {
  switch(type) {
    case 'transfer':
      $('#transactionform #single-account').hide();
      $('#transactionform #categories').hide();
      $('#transactionform #transfer-account').show();
      break;
    default:
      $('#transactionform #single-account').show();
      $('#transactionform #categories').show();
      $('#transactionform #transfer-account').hide();
  }
}

function ChangeMultiple(type){
  switch (type) {
    case 'single':
      $('#transactionform #amount').show();
      $('#transactionform #transactions').hide();
      break;
    default:
      $('#transactionform #amount').hide();
      $('#transactionform #transactions').show();
  }
}

function GetTotalFromMultiple($target) {
  var text = $target.val();
  lines = text.split('\n');

  var total = 0
  for (i=0; i<lines.length; i++){
    words = lines[i].split(' ');
    if (words.length > 0){
      if (!isNaN(words[words.length - 1])){
        total += parseFloat(words[words.length - 1])
      }
    }
  }

  return total;
}

function UpdateResult(rateTarget, resultTarget, amountTarget, isMultiple){
  $rateTarget = $(rateTarget);
  $resultTarget = $(resultTarget);
  $amountTarget = $(amountTarget);
  if($resultTarget.is(":visible")){
    var rate = $rateTarget.val();
    var amount = 0;
    if (!isMultiple){
      amount = $amountTarget.val();
    } else{
      amount = GetTotalFromMultiple($amountTarget);
    }

    result = Math.round((amount * rate) * 100) / 100

    $resultTarget.val(result);
  }
}

function UpdateRate(rateTarget, resultTarget, amountTarget1, amountTarget2){
  $rateTarget = $(rateTarget);
  $resultTarget = $(resultTarget);
  $amountTarget1 = $(amountTarget1);
  $amountTarget2 = $(amountTarget2);

  isMultiple = false;
  $amountTarget;
  if ($amountTarget1.is(":visible")) {
    $amountTarget = $amountTarget1;
  } else if ($amountTarget2.is(":visible")) {
    $amountTarget = $amountTarget2;
    isMultiple = true;

  } else {
    return
  }

  if($resultTarget.is(":visible")){
    var result = $resultTarget.val();
    var amount = 0;
    if (!isMultiple){
      amount = $amountTarget.val();
    } else{
      amount = GetTotalFromMultiple($amountTarget);
    }

    rate = result / amount
    $rateTarget.val(rate);
  }
}

function ChangeCurrency(selectObject) {
  var currency = selectObject.value;
  var account = get_active_account_name();

  if (account.length > 0) {
    $.ajax({
      type: "GET",
      dataType: "text",
      url: "/api/account_currency/" + account,
      success: function(data_currency) {
        if (data_currency != currency){
          $('#transactionform #currency-rate').show();
          $('#transactionform #currency-result').show();

          $.ajax({
            type: "GET",
            dataType: "text",
            url: "/api/currency_rate/" + currency + "/" + data_currency,
            success: function(data_rate) {
              $('#transactionform #currency-rate input').val(data_rate);

              var result = 0;
              if ($('#transactionform #amount').is(":visible")){
                result = $('#transactionform #amount input').val() * data_rate
              } else{
                result = GetTotalFromMultiple($('#transactionform #transactions textarea')) * data_rate
              }

              $('#transactionform #currency-result input').val(result);
            }
          });

        } else {
          $('#transactionform #currency-rate').hide();
          $('#transactionform #currency-result').hide();
          $('#transactionform #currency-rate input').val('');
          $('#transactionform #currency-result input').val('');
        }
      }
    });
  }
}

function ResetTransactionMenu(){
  // reset the button-group elements
  $('#transactionform #button-group').each(function(index){
    $(this).find('input').each(function(i){
      $(this).prop("checked", i==0)
    });
    $(this).find('label').each(function(i){
      if(i == 0){
        $(this).addClass('active');
      } else {
        $(this).removeClass('active');
      }
    });
  });

  // reset the text inputs
  $('#transactionform input.form-control, #transactionform textarea.form-control').each(function(index){
    $(this).val('');
  });

  // update date & time
  $('#transactionform #transaction_date').val(get_date());
  $('#transactionform #transaction_time').val(get_time());

  // update account & currency dropdowns
  var account = get_active_account_name();
  if (account.length > 0) {
    $('#transactionform #transaction_active_account').val(account);
    $('#transactionform #transaction_account').val(account);
    $('#transactionform #transaction_from_account').val(account);

    $.ajax({
      type: "GET",
      dataType: "text",
      url: "/api/account_currency/" + account,
      success: function(data) {
        $("#transactionform #transaction_currency").val(data);
      }
    });
  } else {
    $.ajax({
      type: "GET",
      dataType: "text",
      url: "/api/user_currency/" + account,
      success: function(data) {
        $("#transactionform #transaction_currency").val(data);
      }
    });
  }

  // update the category dropdown
  $('#transactionform #transaction_category_id').val(0);
  var optionHtml = $('#transactionform #categoriesDropdownOptions').find('li').first().html();
  $('#transactionform button#categories-dropdown').html(optionHtml);

  // show & hide correct fields
  $('#transactionform div.default-show').show();
  $('#transactionform div.default-hide').hide();
}