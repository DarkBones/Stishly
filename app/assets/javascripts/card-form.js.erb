var currencyChanged = false;
var transaction_type = 'expense'
var multiple_transactions = false;

function disableEnter() {
  $(document).on("keypress", '#scheduleform', function (e) {
      var code = e.keyCode || e.which;
      if (code == 13) {
          e.preventDefault();
          return false;
      }
  });
}

// auto-focus on account name field
$(document).on('show.bs.modal','#accountform', function () {
  setTimeout(function(){ 
    $('#accountform #account_name').trigger('focus');
  }, 500);
});

// auto-focus on transaction description field
$(document).on('show.bs.modal','#transactionform', function () {
  setTimeout(function(){ 
    //$('#transactionform #transaction_description').trigger('focus');
  }, 500);
});



function changeTransactionType(type) {
  transaction_type = type
  showTransferCurrencyRates();
  switch(type) {
    case 'transfer':
      $('#transactionform #single-account').hide();
      $('#transactionform #categories').hide();
      $('#transactionform #transfer-account').show();
      $('#transactionform #type').removeClass('bg-danger');
      $('#transactionform #type').addClass('bg-warning');
      $('#transactionform #type').removeClass('bg-success');
      $('#transactionform #transaction-currency-options').hide();
      break;
    case 'income':
      $('#transactionform #single-account').show();
      $('#transactionform #categories').show();
      $('#transactionform #transfer-account').hide();
      $('#transactionform #type').removeClass('bg-danger');
      $('#transactionform #type').removeClass('bg-warning');
      $('#transactionform #type').addClass('bg-success');
      $('#transactionform #transaction-currency-options').show();
      break;
    default:
      $('#transactionform #single-account').show();
      $('#transactionform #categories').show();
      $('#transactionform #transfer-account').hide();
      $('#transactionform #type').addClass('bg-danger');
      $('#transactionform #type').removeClass('bg-warning');
      $('#transactionform #type').removeClass('bg-success');
      $('#transactionform #transaction-currency-options').show();
  }
}

function changeTransactionMultiple(type){
  switch (type) {
    case 'single':
      $('#transactionform #amount').show();
      $('#transactionform #transactions').hide();
      multiple_transactions = false;
      break;
    default:
      $('#transactionform #amount').hide();
      $('#transactionform #transactions').show();
      multiple_transactions = true;
      // update the total amount
      updateTransactionsTotal('#transactionform #transactions-total','#transactionform #transactions textarea' ,'#transactionform #transaction_currency');
  }

  updateTransactionResult();
}

function getTransactionTotalFromMultiple($target) {
  var text = "";
  var lines = [];
  var total = 0;
  var words = [];
  var i = 0;

  text = $target.val();
  lines = text.split('\n');

  for (i=0; i<lines.length; i++){
    if (lines[i].length > 0){
      words = lines[i].split(' ');
      if (words.length > 0){
        if (!isNaN(words[words.length - 1])){
          total += parseFloat(words[words.length - 1])
        }
      }
    }
  }

  return total;
}

function updateTransactionResult() {
  var rate = 1;
  var amount = 0;
  var $accountTarget;
  var $rateTarget = $("#transactionform #transaction_rate");
  var $resultTarget = $("#transactionform #transaction_account_currency");
  var $amountTarget = $("#transactionform #transaction_amount");
  
  if (multiple_transactions) {
    $amountTarget = $("#transactionform #transaction_transactions");
  }

  if (transaction_type === 'transfer') {
    $rateTarget = $("#transactionform #transaction_rate_from_to");
    $resultTarget = $("#transactionform #transaction_to_account_currency");
    $accountTarget = $("#transactionform #transaction_to_account");
  } else {
    $accountTarget = $("#transactionform #transaction_account");
  }

  if ($resultTarget.is(":visible")){
    rate = $rateTarget.val();
    if (multiple_transactions) {
      amount = getTransactionTotalFromMultiple($amountTarget);
    } else {
      amount = $amountTarget.val();
    }
  }

  $.ajax({
    type: "GET",
    dataType: "json",
    url: "/api/account_currency_details/" + encodeURI($accountTarget.val()),
    success(data) {
      result = Math.round((amount * rate) * data.subunit_to_unit) / data.subunit_to_unit
      $resultTarget.val(result);

      if (multiple_transactions){
        updateTransactionsTotal('#transactionform #transactions-total','#transactionform #transactions textarea' ,'#transactionform #transaction_currency');
      }
    }
  });
}

function updateTransactionRate(rateTarget, resultTarget, amountTarget1, amountTarget2){
  var $rateTarget = $(rateTarget);
  var $resultTarget = $(resultTarget);
  var $amountTarget1 = $(amountTarget1);
  var $amountTarget2 = $(amountTarget2);
  var isMultiple = false;
  var $amountTarget = $();
  var result = 0;
  var amount = 0;
  var rate = 0;

  if ($amountTarget1.is(":visible")) {
    $amountTarget = $amountTarget1;
  } else if ($amountTarget2.is(":visible")) {
    $amountTarget = $amountTarget2;
    isMultiple = true;
  } else {
    return
  }

  if($resultTarget.is(":visible")){
    result = $resultTarget.val();
    if (!isMultiple){
      amount = $amountTarget.val();
    } else{
      amount = getTransactionTotalFromMultiple($amountTarget);
    }

    rate = result / amount
    $rateTarget.val(rate);
  }
}

function changeTransactionAccount(selectObject) {
  var account = selectObject.value;

  $('#transactionform #transaction_account').val(account);
  $('#transactionform #transaction_from_account').val(account);

  if (transaction_type != 'transfer') {
    if (!currencyChanged){
      $.ajax({
        type: "GET",
        dataType: "text",
        url: "/api/account_currency/" + encodeURI(account),
        success: function(data) {
          $("#transactionform #transaction_currency").val(data);
        }
      });
    } else {
      changeTransactionCurrency($('#transactionform #transaction_currency').val());
    }
  } else {
    showTransferCurrencyRates();
  }
}

function changeTransactionToAccount(selectObject) {
  showTransferCurrencyRates();
}

function showTransferCurrencyRates() {
  if (transaction_type == 'transfer') {
    $('#transactionform #transaction-currency-options').hide();
    var from = "";
    var to = "";

    from = encodeURI($("#transactionform #transaction_from_account").val());
    to = encodeURI($("#transactionform #transaction_to_account").val());

    $.ajax({
      type: "GET",
      dataType: "json",
      url: "/api/transfer_accounts/" + from + "/" + to,
      success: function(data) {
        if (data.from_account.currency !== data.to_account.currency){
          $("#transactionform #to_account_currency").text('Amount in ' + data.to_account.currency);
          $('#transactionform #transfer-currencies').show();
          $('#transactionform #rate_from_to').text('Rate ' + data.from_account.currency + ' to ' + data.to_account.currency);
          $('#transactionform #transaction_rate_from_to').val(data.currency_rate);
        } else {
          $('#transactionform #transaction_rate_from_to').val(data.currency_rate);
          $('#transactionform #transfer-currencies').hide();
        }

        updateTransactionResult();
      }
    });
  } else {
    $('#transactionform #transaction_rate_from_to').val(1);
    $('#transactionform #transfer-currencies').hide();
    $('#transactionform #transaction-currency-options').show();
  }

  updateTransactionResult();
}

function changeTransactionCurrency(selectObject, currency='') {
  var account = "";
  var result = 0;

  $('#transactionform #currency-rate').hide();
  $('#transactionform #currency-result').hide();

  currencyChanged = true;
  if(currency.length == 0){
    var currency = $("#transactionform #transaction_currency").val();
  }

  account = $('#transactionform #single-account select').val();

  $.ajax({
    type: "GET",
    dataType: "json",
    url: "/api/account_currency_details/" + encodeURI(account),
    success: function(data_currency) {
      if (data_currency.iso_code != currency){
        $('#transactionform #exchange_rate_spinner').show();
        $.ajax({
          type: "GET",
          dataType: "text",
          url: "/api/currency_rate/" + currency + "/" + data_currency.iso_code,
          success: function(data_rate) {
            $('#transactionform #exchange_rate_spinner').hide();
            $('#transactionform #account_currency').text('Amount in ' + data_currency.iso_code);
            $('#transactionform #currency-rate').show();
            $('#transactionform #currency-result').show();
            $('#transactionform #currency-rate input').val(data_rate);

            if ($('#transactionform #amount').is(":visible")){
              result = $('#transactionform #amount input').val() * data_rate
            } else{
              result = getTransactionTotalFromMultiple($('#transactionform #transactions textarea')) * data_rate
            }

            $('#transactionform #currency-result input').val(Math.round(result * data_currency.subunit_to_unit) / data_currency.subunit_to_unit);
          }
        });

      } else {
        $('#transactionform #currency-rate').hide();
        $('#transactionform #currency-result').hide();
        $('#transactionform #currency-rate input').val('');
        $('#transactionform #currency-result input').val('');
      }
    }
  });
  updateTransactionsTotal('#transactionform #transactions-total','#transactionform #transactions textarea' ,'#transactionform #transaction_currency');
  updateTransactionResult();
}

function updateTransactionsTotal(targetTotal, targetTransactions, targetCurrency){
  var $targetTotal = $(targetTotal);
  var $targetTransactions = $(targetTransactions);
  var $targetCurrency = $(targetCurrency);

  var total = getTransactionTotalFromMultiple($targetTransactions);
  total = total.toString().replace('.', '$');
  var currency = $targetCurrency.val();

  $.ajax({
    type: 'GET',
    dataType: 'text',
    url: '/api/format_currency/' + total + '/' + currency + '/true',
    success: function(data) {
      $targetTotal.text(data);
    }
  });
}

function resetAccountMenu(){
  $('#accountform').find("input[type=text], textarea").val("");

  $.ajax({
    type: "GET",
    dataType: "text",
    url: "/api/account_currency/",
    success: function(data) {
      $('#accountform').find('select').val(data);
    }
  });
}

function resetTransactionMenu(){
  var active_account = "";
  var account = "";
  var optionHtml = "";

  setTimeout(function(){ 
    $('#transactionform #transaction_description').trigger('focus');
  }, 500);

  currencyChanged = false;
  transaction_type = 'expense'
  multiple_transactions = false;

  // update the active account field
  active_account = getActiveAccountName();
  $('#transactionform #active_account_field').val(active_account);
  if (active_account) {
    $('#transactionform #transaction_account').val(active_account);
    $('#transactionform #transaction_from_account').val(active_account);
  } else {
    $("#transactionform #transaction_account").val($("#transactionform #transaction_account option:first").val());
    $("#transactionform #transaction_from_account").val($("#transactionform #transaction_from_account option:first").val());
  }
  $("#transactionform #transaction_to_account").val($("#transactionform #transaction_to_account option:first").val());

  // reset the button-group elements
  $('#transactionform #button-group').each(function(index){
    $(this).find('input').each(function(i){
      $(this).prop("checked", i==0)
    });
    $(this).find('label').each(function(i){
      if(i == 0){
        $(this).addClass('active');
      } else {
        $(this).removeClass('active');
      }
    });
  });

  // reset the text inputs
  $('#transactionform input.form-control, #transactionform textarea.form-control').each(function(index){
    $(this).val('');
  });

  // update date & time
  $('#transactionform #transaction_date').val(getDate());
  $('#transactionform #transaction_time').val(getTime());

  // reset type color
  changeTransactionType('expense');

  // update account & currency dropdowns
  account = $('#transactionform #single-account select').val();
  if (account) {
    $('#transactionform #transaction_active_account').val(account);

    $.ajax({
      type: "GET",
      dataType: "text",
      url: "/api/account_currency/" + encodeURI(account),
      success: function(data) {
        $("#transactionform #transaction_currency").val(data);
      }
    });
  } else {
    $.ajax({
      type: "GET",
      dataType: "text",
      url: "/api/user_currency",
      success: function(data) {
        $("#transactionform #transaction_currency").val(data);
      }
    });
  }

  // update the category dropdown
  $('#transactionform #transaction_category_id').val(0);
  optionHtml = $('#transactionform #categoriesDropdownOptions').find('li').first().html();
  $('#transactionform button#categories-dropdown').html(optionHtml);

  // show & hide correct fields
  $('#transactionform div.default-show').show();
  $('#transactionform div.default-hide').hide();
}