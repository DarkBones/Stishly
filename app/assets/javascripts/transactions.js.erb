//"use strict";

/*function set_currency(account_name, currency_changed, $currency_field) {
  if(!currency_changed) {
    var currency;
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "/api/accounts/" + account_name + '/details',
      success: function(data){
        currency = data.currency;
        $currency_field.val(currency);
      }
    });
  }
}*/


$(document).on('turbolinks:load', ()=> {
  var transactionmenu_set = false;

  $('#create-transaction-button').on('click', () => {
    ToggleCardForm('#transactionmenu');
    SetupTransactionForm();
  });
});

$(document).on('click', '.show-child-transactions', (event) => {
  $(event.currentTarget).nextAll('.child_transactions:first').slideToggle(100);

  if ($(event.currentTarget).find('img').hasClass('rotated')) {
    $(event.currentTarget).find('img').removeClass('rotated');
    $(event.currentTarget).find('img').addClass('rotated-back');
  } else {
    $(event.currentTarget).find('img').removeClass('rotated-back');
    $(event.currentTarget).find('img').addClass('rotated');
  }
});

function enableMassActionButtons() {
  var $buttons;

  $buttons = $(".mass_transaction_action_button");
  if ($("#selected-transactions").val().length > 0) {
    $buttons.each(function(index, value){
      $("#" + value.id).removeClass("disabled");
    });
  } else {
    $buttons.each(function(index, value){
      $("#" + value.id).addClass("disabled");
    });
  }
}

function selectTransaction(obj) {
  if (obj.checked) {
    $(obj).parents(".select-item-container").addClass("selected-row");
    addTransaction(obj.value);
  } else {
    $(obj).parents(".select-item-container").removeClass("selected-row");
    removeTransaction(obj.value);
  }

  enableMassActionButtons();
}

function selectAllTransactions(obj) {
  if (obj.checked) {
    addAllTransactions();
  } else {
    removeAllTransactions();
  }

  enableMassActionButtons();
}

function addAllTransactions() {
  var $transactions;

  $transactions = $(".transaction-checkbox-input");
  $transactions.each(function(index, value){
    $(value).parents(".select-item-container").addClass("selected-row");
    value.checked = true;
    addTransaction(value.value);
  });
}

function removeAllTransactions() {
  var $transactions;

  $transactions = $(".transaction-checkbox-input");
  $transactions.each(function(index, value){
    $(value).parents(".select-item-container").removeClass("selected-row");
    value.checked = false;
    removeTransaction(value.value);
  });
}

function addTransaction(tId) {
  var $selectedTarget, selectedStr, selectedArr, currentId;

  $selectedTarget = $("#selected-transactions");
  selectedStr = $selectedTarget.val();
  selectedArr = selectedStr.split(" ");

  // check if transaction id is already in the list
  currentId = "";
  while (typeof(currentId) !== "undefined") {
    currentId = selectedArr.pop();
    if (currentId === tId) {
      return;
    }
  }

  $selectedTarget.val((selectedStr + " " + tId).trim())
}

function removeTransaction(tId) {
  var $selectedTarget, selectedStr, selectedArr, index;

  $selectedTarget = $("#selected-transactions");
  selectedStr = $selectedTarget.val();
  selectedArr = selectedStr.split(" ");

  index = selectedArr.indexOf(tId);
  if (index > -1) {
    selectedArr.splice(index, 1);
  }

  $selectedTarget.val(selectedArr.join(" "));
}

function editTransaction(obj){
  var transactionId = $(obj).attr("id");

  $("#edit_transaction_form_fields").html("");
  $.ajax({
    type: "GET",
    dataType: "html",
    url: "/api/v1/forms/transactions/edit/" + transactionId.toString(),
    beforeSend() {
      insertAjaxSpinner($("#edit_transaction_form_fields"));
    },
    success(data) {
      $("#edit_transaction_form_fields").html(data);
      setDatepickers();
      addLadderformListeners();
      setTimezones();
    }
  });
}

function editTransactionOLD(obj) {
  var transactionId = $(obj).parents("tr").attr("series-id");
  var scheduleId = $(obj).parents("tr").attr("schedule");
  var schedulePeriod = $(obj).parents("tr").attr("period");
  var tId = $(obj).parents("tr").attr("id").split("_")[1];
  var scheduledTransactionId = $(obj).parents("tr").attr("scheduled-transaction")
  
  originalTId = tId;

  $("#edit_upcoming_transaction_form_fields").html("");
  $("#edit_upcoming_transaction_form #transaction_name").text("");
  $.ajax({
    type: "GET",
    dataType: "html",
    url: "/api/v1/forms/transactions/upcoming/edit_occurrence/" + transactionId.toString() + "/" + scheduleId.toString() + "/" + schedulePeriod.toString() + "/" + scheduledTransactionId.toString(),
    beforeSend() {
      insertAjaxSpinner($("#edit_upcoming_transaction_form_fields"));
    },
    success(data) {
      $("#edit_upcoming_transaction_form_fields").html(data);
      setDatepickers();
      addLadderformListeners();
      setTimezones();
      $.ajax({
        type: "GET",
        dataType: "json",
        url: "/api/v1/transactions/" + transactionId.toString(),
        success(data) {
          $("#edit_upcoming_transaction_form #transaction_name").text(data.description);
        }
      });
    }
  });
}